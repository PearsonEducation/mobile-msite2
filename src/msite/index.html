<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Happenings</title>
		<link rel="stylesheet" href="css/jquery.mobile-1.0a3.css" />
		<link rel="stylesheet" href="css/msite.css" />
		<link rel="stylesheet" href="css/branding.css" />
<style>

h2 {
	text-align: center;
}

#loginPage div.container-footer p {
	text-align: left;
	margin-left: 1em;
	font-size: 80%;
}
#loginPage div.container-footer p a {
	text-decoration: none;
	
}

</style>
		<script type="text/javascript" src="scripts/jquery/jquery-1.5.1.min.js"></script>
		<script type="text/javascript" src="scripts/jquery/jquery.mobile-1.0a3.js"></script>
		<script type="text/javascript" src="scripts/json2.js"></script>
		<script type="text/javascript" src="scripts/ecollege/AjaxManager.js"></script>
		<script type="text/javascript" src="scripts/ecollege/VariableValidator.js"></script>
		<script type="text/javascript" src="scripts/ecollege/AjaxRequestHeader.js"></script>
		<script type="text/javascript" src="scripts/ecollege/CrossDomainInitializer.js"></script>
		<script type="text/javascript" src="scripts/ecollege/CrossFrameMessage.js"></script>
		<script type="text/javascript" src="scripts/ecollege/CustomEvent.js"></script>
		<script type="text/javascript" src="scripts/ecollege/DomainStatusEvent.js"></script>
		<script type="text/javascript" src="scripts/ecollege/EventDispatcher.js"></script>
		<script type="text/javascript" src="scripts/ecollege/SessionManager.js"></script>
		<script type="text/javascript" src="scripts/ecollege/Utils.js"></script>
		<script type="text/javascript" src="scripts/ecollege/ConfigSettings.js"></script>
		<script type="text/javascript" src="scripts/ecollege/ClientStringManager.js"></script>
		<script type="text/javascript" src="scripts/ecollege/preloadUtils.js"></script>
		<script type="text/javascript" src="scripts/jquery/jquery.msiteConnect.js"></script>
		<script type="text/javascript" src="scripts/i8ln/en-us/strings.js"></script>
		<script>
// Check to see if there is already an access grant of some sort.  If there is, we should forward on to home page.
var accessCookie = readCookie("access_grant");
if (accessCookie && (accessCookie.length >0) ) {
	$(location).attr("href", "home.html");
}

var signInClickHandler = function() {
	if ($("#userId").val == "" || $("#password").val() == "") {
		$("#dialogError .errorMessage").html(msite.localization.index["username-password-required"]);
		$("#show-error-message").click();
		return;
	}
	
	$.mobile.pageLoading();
	clientStringManager.setClientString(cs);	// just in case the user clears their cookies after page loads
	// get only the client string part of the entire client sort string (the text before the first ".")
	var epClientString = cs.split(".", 1)[0];
	sessionManager.logIn(epClientString, $("#userId").val(), $("#password").val(), $("#rememberMe")[0].checked, signInHandler);
};

/**
	Handler for a response to authorize a user. If a user was authorized successfully, 
	redirect them to the main page. Otherwise show them an error.
	@param		{Boolean}	p_isLoggedIn	true if the user was authorized successfully, false otherwise
	@param		{String}	p_errorCode		the HTTP error code on the response
*/
var signInHandler = function(p_isLoggedIn, p_errorCode) {
	if (p_isLoggedIn) {
		eraseCookie("currentPage");
		//$.mobile.changePage("home.html");
		$(location).attr("href", "home.html");
		//window.location="home.html";
		return;
	}
	//not logged in, what went wrong?
	switch(p_errorCode) {
		case "400":
			// if the response was a "bad request", show message that login credentials were incorrect.
			$("#dialogError div.errorMessage").html(msite.localization.index["username-password-incorrect"]);
			break;
		case "500":
			// if the response was a 500 "internal server error", show a message of the likely cause.
			$("#dialogError div.errorMessage").html(msite.localization.index["generic-server-error"]);
			break;
		default:
			// otherwise show a general message that the communication was unsuccessful.
			$("#dialogError div.errorMessage").html(msite.localization.index["generic-server-error"]);
	}
	$.mobile.pageLoading(true);
	$("#show-error-message").click();
};

/**
	When the user clicks the register button, attempt to register them
*/
var registerClickHandler = function() {
	if ($("#lastName").val == "" || $("#systemEmail").val() == "") {
		$("#dialogError div.errorMessage").html(msite.localization.index["lastname-email-required"]);
		$("#show-error-message").click();
		return;
	}
	$.mobile.pageLoading();
	sessionManager.register(clientStringManager.getClientString(), $("#lastName").val(), $("#systemEmail").val(), registerHandler);
};

/**
	Handler for a response to authorize a user. If a user was authorized successfully, 
	redirect them to the main page. Otherwise show them an error.
	@param		{Boolean}	p_success	true if the user was authorized successfully, false otherwise
	@param		{String}	p_errorCode		the HTTP error code on the response
*/
var registerHandler = function(p_success, p_errorCode)
{
	$("#registerButton").show();
	$("#loadingImage").hide();
	if (p_success) 	{
		eraseCookie("currentPage");
		$("#emailSentTo").html($("#systemEmail").val());
		$.mobile.changePage("#dialogSuccess", "flip");
		return;
	}
	//not logged in, what went wrong?
	switch(p_errorCode) {
		case "400":
			// if the response was a "bad request", show message that login credentials were incorrect.
			$("#dialogError div.errorMessage").html(msite.localization.index['unable-to-verify']);
			break;
		case "500":
			// if the response was a 500 "internal server error", show a message of the likely cause.
			$("#dialogError div.errorMessage").html(msite.localization.index["generic-server-error"]);
			break;
		default:
			// otherwise show a general message that the communication was unsuccessful.
			$("#dialogError div.errorMessage").html(msite.localization.index["timeout"]);
	}
	$.mobile.pageLoading(true);
	$("#show-error-message").click();
	
};
$(document).ready(function() {
	$().msiteConnect({
		crossDomainErrorHandler : function() {
			$("#dialogError div.errorMessage").html(msite.localization.index["generic-server-error"]);
			$("#show-error-message").click();
		}
	});
	
	// assign actions to the sign in button
	$("#signInBtn").bind("click", signInClickHandler);
	
	// listen for form submit events, and forward them to the sign in click handler
	$("#loginForm").bind("submit", function(p_event) {
		p_event.preventDefault();
		signInClickHandler();
	});
	
	// assign actions to the register button
	$("#registerButton").bind("click", registerClickHandler);
	
	// listen for form submit events, and forward them to the sign in click handler
	$("#registerFormContainer").bind("submit", function(p_event) {
		p_event.preventDefault();
		registerClickHandler();
	});
	
	
})
		</script>
		
	</head>
	<body>
		
		<!-- Begin login page -->
		<div data-role="page" id="loginPage">
			<div class="section_header" data-role="header">
				<h1>Pearson</h1>
			</div>
			<div id="loginFormSection" class="section_content" data-role="content">
				
				<div id="loginFormContainer">
					<h2>eCollege Mobile</h2>
					<form method="GET" id="loginForm" action="submit">
						<div class="authFields">
							<ul data-role="listview" data-inset="true" data-theme="d" data-dividertheme="b">
								<li>
									<label for="userId">Username:</label>
									<input class="inputtext" type="text" name="userId" id="userId" autocapitalize="off" />
								</li>
								<li>
									<label for="password">Password:</label>
									<input class="inputtext" type="password" name="password" id="password" autocapitalize="off" />
								</li>
								<li>
									<input type="checkbox" name="rememberMe" id="rememberMe" />
									<label for="rememberMe">Remember me</label>
								</li>
							</ul>
						</div>
					</form>
					<button type="submit" id="signInBtn">Sign In</button>
				</div>
			</div>
				
			<div data-role="footer" class="container-footer">
				<p><a href="#registerPage" data-transition="flip" >Don't know your user name and password? Tap here to get an access link emailed to you.</a></p>
			</div>
		</div>
		<!-- End login page -->
		
		
		<!-- Begin Registration Page -->
		<div id="registerPage" data-role="page">
			<div class="section_header" data-role="header">
				<h1>Pearson</h1>
			</div>
			<div id="registerFormSection" class="section_content" data-role="content">
				
				<div class="authSuccess" id="successContainer" style="display:none;">
					<span class="authHeader">Your Mobile Access Link is on the way!</span> 
					<span class="authText">We have sent an email to the following email address: <span id="emailSentTo" class="bold">&nbsp;</span> </span>
					<ul class="steps"> 
						<li>Make sure you are checking the correct email account.</li> 
						<li>If you don't receive the email within 10 minutes, check your junk mail filter.</li> 
						<li>Access links expire after 1 hour. If your link has expired, you can <a id="registerLink" href="javascript:void(0);">have another one sent</a>.</li> 
						<li>If you continue to have problems, contact the helpdesk. </li>
					</ul>
				</div>
				
				<h2>Get a Mobile Access Link</h2>
				<div id="registerFormContainer">
					<form method="GET" name="" id="" action="submit">
						<p>Enter some information so we can register you:</p>
						<div class="authFields">
							<ul data-role="listview" data-inset="true" data-theme="d" data-dividertheme="b">
								<li>
									<label for="lastName">Last Name</label>
									<input type="text" name="lastName" id="lastName" />
								</li>
								<li>
									<label for="systemEmail">Email Address: </label>
									<input type="email" name="systemEmail" id="systemEmail" autocapitalize="off" />
								</li>
							</ul>
						</div>
					</form>
					<button type="submit" id="registerButton">Email My Access Link</button>
				</div>

				<div data-role="collapsible" data-collapsed="true">
					<h3>Having trouble getting access?</h3>
					<ul class="steps">
						<li>Make sure you are checking the correct email account.</li>
						<li>The link in the email must be clicked from within your mobile device.</li>
						<li>If you don't receive the email within 10 minutes of requesting, check your junk mail filter.</li>
						<li>Access links expire after 1 hour. If your link has expired, you can have another one sent.</li>
						<li>If you continue to have problems, contact the helpdesk.</li>
					</ul>
				</div>
				
			</div>
				
			<div data-role="footer">
				<a data-icon="arrow-l" data-rel="back" href="#loginPage">Back</a>
			</div>

		</div>
		<!-- End Registration Page -->
		
		<!-- Begin Error Dialog -->
		<div id="dialogError" data-role="page">
			<div class="section_header" data-role="header">
				<h2>Error</h2>
			</div>
			<div data-role="content">
				<div class="errorMessage"></div>
			</div>
		</div>
		<!-- End Login Error Dialog -->
		
		<!-- Begin Success Dialog -->
		<div id="dialogSuccess" data-role="page">
			<div class="section_header" data-role="header">
				<h2>Mobile Access Link Sent</h2>
			</div>
			<div data-role="content">
				<h3>Your Mobile Access Link is on the way!</h3> 
				<p>We have sent an email to the following email address: <span id="emailSentTo" class="bold">&nbsp;</span> </p>
				<ul class="steps"> 
					<li>Make sure you are checking the correct email account.</li> 
					<li>If you don't receive the email within 10 minutes, check your junk mail filter.</li> 
					<li>Access links expire after 1 hour. If your link has expired, you can have another one sent.</li> 
					<li>If you continue to have problems, contact the helpdesk. </li>
				</ul>
			</div>

			<div id="registerPageFooter" class="section_footer">
				<div class="brandBottom"><span class="brandtextB">University</span></div>
			</div>
		</div>
		<!-- End Success Dialog -->
		
		<!-- Cross-site iframe -->
		<iframe id="crossDomainCommunicationFrame" src="" style="display:none"></iframe>

		<!-- Show error message link -->
		<p><a id="show-error-message" href="#dialogError" data-rel="dialog" data-transition="slidedown" style="display: none;" >Show Error Message</a></p>
		
	</body>

</html>